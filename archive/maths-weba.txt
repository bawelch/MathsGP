<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Force-Directed Graph</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    .link {
      stroke: #999;
      stroke-opacity: 0.6;
    }
    .node circle {
      stroke: #555;
      stroke-width: 1.5px;
    }
    .node text {
      font-size: 10px;
      font-family: sans-serif;
    }
    .tooltip {
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 5px;
      font-size: 12px;
      font-family: sans-serif;
      pointer-events: none;
      visibility: hidden;
    }
    .controls-container {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      padding: 10px;
      background: rgba(255, 255, 255, 0.9);
      border-bottom: 1px solid #ddd;
      box-sizing: border-box;
    }
    .controls {
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: sans-serif;
      font-size: 12px;
      box-sizing: border-box;
    }
    .text-box {
      margin-left: 10px;
      flex-grow: 1;
      background: rgba(245, 245, 245, 1);
      border: 1px solid #ddd;
      padding: 10px;
      font-family: sans-serif;
      font-size: 12px;
      line-height: 1.5;
      border-radius: 5px;
      height: fit-content;
      box-sizing: border-box;
    }
    svg {
      display: block;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div class="controls-container">
    <div class="controls">
      <div>
        <div class="slider-label">
          <span>Link Distance</span><span id="linkDistanceValue">500</span>
        </div>
        <input type="range" id="linkDistance" min="100" max="2000" step="100" value="500">
      </div>
      <div>
        <div class="slider-label">
          <span>Charge Strength</span><span id="chargeStrengthValue">-1000</span>
        </div>
        <input type="range" id="chargeStrength" min="-5000" max="0" step="100" value="-1000">
      </div>
      <div>
        <div class="slider-label">
          <span>Collision Radius</span><span id="collisionRadiusValue">200</span>
        </div>
        <input type="range" id="collisionRadius" min="50" max="500" step="50" value="200">
      </div>
    </div>
    <div class="text-box" id="textBox">
      Click on a node to see its details here.
    </div>
  </div>
  <div class="tooltip"></div>
  <svg></svg>
  <script>
    function adjustSVGHeight() {
      const controlsHeight = document.querySelector(".controls-container").offsetHeight;
      const svgWidth = window.innerWidth;
      const svgHeight = window.innerHeight - controlsHeight;

      d3.select("svg")
        .attr("width", svgWidth)
        .attr("height", svgHeight);

      return { svgWidth, svgHeight };
    }

    let { svgWidth, svgHeight } = adjustSVGHeight();

    const svg = d3.select("svg");
    const g = svg.append("g");

    // Load data from mgpdata.json file
    d3.json("mgpdata.json").then(graphData => {
      const nodes = graphData.nodes;
      const links = graphData.links;

      // Default simulation parameters
      let linkDistance = 500;
      let chargeStrength = -1000;
      let collisionRadius = 200;

      // Validate node years
      nodes.forEach((d, i) => {
        if (d.y == null || d.y < 0 || isNaN(d.y)) {
          console.warn(`Invalid year for node "${d.id}":`, d.y);
          d.y = 0; // Default or placeholder for invalid years
        }
	d.year = d.y;
        d.fixedY = svgHeight - ((d.y - 1660) / (2005 - 1660)) * svgHeight;
        d.fixedY = Math.max(10, Math.min(svgHeight - 10, d.fixedY)); // Ensure Y is within bounds
        if (i === 0) {
          d.fixedX = svgWidth / 2; // Fix the x position for the first node
        }
      });

      const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(linkDistance))
        .force("charge", d3.forceManyBody().strength(chargeStrength))
        .force("x", d3.forceX(svgWidth / 2).strength(0.1))
        .force("y", null) // Disable Y forces
        .force("collision", d3.forceCollide().radius(collisionRadius)) // Collision force based on node size
        .on("tick", ticked);

      const link = g.append("g")
        .attr("class", "links")
        .selectAll("line")
        .data(links)
        .enter().append("line")
        .attr("class", "link");

      const node = g.append("g")
        .attr("class", "nodes")
        .selectAll("g")
        .data(nodes)
        .enter().append("g")
        .attr("class", "node");

      node.append("circle")
        .attr("r", d => d.size)
        .attr("fill", d => d.color)
        .on("mouseover", (event, d) => {
          const tooltip = d3.select(".tooltip");
          tooltip
            .style("visibility", "visible")
            .style("top", `${event.pageY + 10}px`)
            .style("left", `${event.pageX + 10}px`)
            .html(`<strong>${d.id} (${d.year})</strong><br>${d.tooltip}`);
        })
        .on("mousemove", (event) => {
          d3.select(".tooltip")
            .style("top", `${event.pageY + 10}px`)
            .style("left", `${event.pageX + 10}px`);
        })
        .on("mouseout", () => {
          d3.select(".tooltip").style("visibility", "hidden");
        })
        .on("click", (event, d) => {
          const incomingLinks = links
            .filter(link => link.target.id === d.id)
            .map(link => `${link.source.id} (${link.source.year}) (A)`);

          const outgoingLinks = links
            .filter(link => link.source.id === d.id)
            .map(link => `${link.target.id} (${link.target.year}) (S)`);

          const textBoxContent = `
            <strong>Name:</strong> ${d.id}<br>
            <strong>Year:</strong> ${d.year}<br>
            <strong>Connected Nodes:</strong><br>
            ${[...incomingLinks, ...outgoingLinks].join('<br>') || 'None'}<br>
            <strong>Summary:</strong> ${d.tooltip}
          `;

          d3.select("#textBox").html(textBoxContent);
        });

      node.append("text")
        .attr("x", d => d.size + 4)
        .attr("y", 3)
        .text(d => d.id);

      function ticked() {
        link
          .attr("x1", d => Math.max(10, Math.min(svgWidth - 10, d.source.x)))
          .attr("y1", d => d.source.fixedY)
          .attr("x2", d => Math.max(10, Math.min(svgWidth - 10, d.target.x)))
          .attr("y2", d => d.target.fixedY);

        node
          .attr("transform", d => {
            d.x = d.fixedX || d.x;
            return `translate(${Math.max(10, Math.min(svgWidth - 10, d.x))},${d.fixedY})`;
          });
      }

      simulation.alpha(1).restart();

      // Slider event listeners to update graph parameters dynamically
      d3.select("#linkDistance").on("input", function () {
        linkDistance = +this.value;
        d3.select("#linkDistanceValue").text(linkDistance);
        simulation.force("link", d3.forceLink(links).id(d => d.id).distance(linkDistance));
        simulation.alpha(1).restart();
      });

      d3.select("#chargeStrength").on("input", function () {
        chargeStrength = +this.value;
        d3.select("#chargeStrengthValue").text(chargeStrength);
        simulation.force("charge", d3.forceManyBody().strength(chargeStrength));
        simulation.alpha(1).restart();
      });

      d3.select("#collisionRadius").on("input", function () {
        collisionRadius = +this.value;
        d3.select("#collisionRadiusValue").text(collisionRadius);
        simulation.force("collision", d3.forceCollide().radius(collisionRadius));
        simulation.alpha(1).restart();
      });
    }).catch(error => console.error("Error loading JSON:", error));
  </script>
</body>
</html>
